* M32C SERIES ASSEMBLER *  SOURCE LIST     Wed Mar 05 18:52:21 2014  PAGE 001

  SEQ.  LOC.    OBJ.                    0XMSDA  .*....*....SOURCE STATEMENT....8....*....9....*....0....*....1....*....2....*....3....*....4....*....5....*....6....*....7....*....8....*....9....*....0

     1                                          ;/*
     2                                          ; * Copyright (c) 2014, Juan Angel Hernandez Hdez. for Atomthreads Project.
     3                                          ; * All rights reserved.
     4                                          ; *
     5                                          ; * Redistribution and use in source and binary forms, with or without
     6                                          ; * modification, are permitted provided that the following conditions
     7                                          ; * are met:
     8                                          ; *
     9                                          ; * 1. Redistributions of source code must retain the above copyright
    10                                          ; *    notice, this list of conditions and the following disclaimer.
    11                                          ; * 2. Redistributions in binary form must reproduce the above copyright
    12                                          ; *    notice, this list of conditions and the following disclaimer in the
    13                                          ; *    documentation and/or other materials provided with the distribution.
    14                                          ; * 3. No personal names or organizations' names associated with the
    15                                          ; *    Atomthreads project may be used to endorse or promote products
    16                                          ; *    derived from this software without specific prior written permission.
    17                                          ; *
    18                                          ; * THIS SOFTWARE IS PROVIDED BY THE ATOMTHREADS PROJECT AND CONTRIBUTORS
    19                                          ; * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
    20                                          ; * TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
    21                                          ; * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE PROJECT OR CONTRIBUTORS BE
    22                                          ; * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
    23                                          ; * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
    24                                          ; * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
    25                                          ; * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
    26                                          ; * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
    27                                          ; * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
    28                                          ; * POSSIBILITY OF SUCH DAMAGE.
    29                                          ; */
    30                                          
    31                                          
    32                                          ;/**
    33                                          ; *  \b _timer_b2
    34                                          ; *
    35                                          ; *  Timer B2 1ms interrupt. 
    36                                          ; *  On interrupt, the U flag is cleared meaning that the interrupt stack (IStack)
    37                                          ; *  is selected. FLG and PC are saved on IStack, this routine then cuts and pastes 
    38                                          ; *  FLG and PC from IStack to UStack (User stack) so that all data relevant to a 
    39                                          ; *  thread is kept on the same stack area. This also makes the IStack available to 
    40                                          ; *  use for interrupt nesting.
    41                                          ; *
    42                                          ; *  @return None
    43                                          ; */
    44                                          
    45                                          	.GLB _atomIntEnter
    46                                          	.GLB _atomTimerTick
    47                                          	.GLB $atomIntExit
    48                                          	.GLB __timer_b2
    49                                          	.FB    0    
    50                                          
    51                                              .SECTION    program,CODE,ALIGN
    52                                          	.align
    53                                              .GLB __timer_b2
    54                                              .rvector        23, __timer_b2
    55  000000                                  __timer_b2:		
    56  000000  D12B                            	PUSHC FB      ;Save FB temporary on I stack.
    57  000002  D1EF                                FSET U        ;Select user stack
    58  000004  D12F                                PUSHC ISP     ;Save ISP in U stack
    59  000006  D32B                                POPC  FB      ;POP ISP to FB
    60  000008  C3CE08                          	PUSH.W 8H[FB]  ;Copy FLG from Istack to Ustack
    61  00000B  A2C104                          	PUSH.L 4H[FB]  ;Copy TskX ReturnAddress from Istack to Ustack
    62  00000E  D3EF                                FCLR U        ;Select Istack
* M32C SERIES ASSEMBLER *  SOURCE LIST     Wed Mar 05 18:52:21 2014  PAGE 002

  SEQ.  LOC.    OBJ.                    0XMSDA  .*....*....SOURCE STATEMENT....8....*....9....*....0....*....1....*....2....*....3....*....4....*....5....*....6....*....7....*....8....*....9....*....0

    63  000010  D32B                                POPC FB       ;restore original value of FB
    64  000012  63                          Q       ADD.L #6,SP   ;Clean Istack, so it is free for interrupts.
    65  000013  D1EF                                FSET U        ;Carry on, on Ustack
    66                                          	
    67  000015  CD000000r                   A   	JSR.A _atomIntEnter
    68  000019  CD000000r                   A   	JSR.A _atomTimerTick
    69                                          	
    70  00001D  F8A1                        Q       MOV.B:Q     #1H,R0L ;Pass the TRUE parameter
    71  00001F  CD000000r                   A   	JSR.A $atomIntExit
    72  000023  9E                              	REIT
    73                                          .END

Information List

TOTAL ERROR(S)    00000
TOTAL WARNING(S)  00000
TOTAL LINE(S)     00073   LINES

Section List

Attr         Size           Name
CODE     00000036(000024H)  program
ROMDATA  00000004(000004H)  vector
